<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITN Live Stream (Shaka Player)</title>

    <!-- Shaka Player CSS -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/shaka-player/4.3.4/shaka-player.ui.css">

    <!-- Shaka Player JavaScript library -->
    <script src="https://ajax.googleapis.com/ajax/libs/shaka-player/4.3.4/shaka-player.ui.js"></script>

    <style>
        /* Basic styling for a full-screen player experience */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #000;
            overflow: hidden; /* Prevents scrollbars */
            font-family: Arial, sans-serif;
        }

        /* The container will hold the video element and the UI overlay */
        #video-container {
            width: 100%;
            height: 100%;
        }

        /* The video element itself */
        video {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <!-- 
      The video container which Shaka Player will control.
    -->
    <div data-shaka-player-container id="video-container">
        <!-- 
          The video element. 'autoplay' is used to start playback immediately.
          The native 'controls' attribute is removed because Shaka's UI will provide them.
        -->
        <video autoplay id="video"></video>
    </div>

    <script>
        // The original Akamai HLS manifest URL.
        const manifestUri = 'https://hls-abiri0ry-livepush.akamaized.net/{v1}/nsiPyyYPqaaCfd/em0l9G8dNuBQsYh35/rewind-3600.m3u8?DVR';

        // Asynchronous function to initialize Shaka Player
        async function init() {
            // Get the video and container elements from the DOM
            const video = document.getElementById('video');
            const container = document.getElementById('video-container');

            // Create a Player instance.
            const player = new shaka.Player(video);

            // Attach player to the window to make it easy to debug.
            window.player = player;
            
            // Configure the networking engine to add custom headers that mimic a valid browser request.
            player.getNetworkingEngine().registerRequestFilter((type, request) => {
                // We only need to modify requests for manifests and segments.
                if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
                    type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                    
                    // Add the headers that the server requires for access.
                    request.headers['Origin'] = 'https://itn.lk';
                    request.headers['Referer'] = 'https://itn.lk/';
                    request.headers['User-Agent'] = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36';
                }
            });


            // Initialize the UI.
            const ui = new shaka.ui.Overlay(player, container, video);
            const controls = ui.getControls();

            // Listen for error events from the player and the UI controls.
            player.addEventListener('error', onErrorEvent);
            controls.addEventListener('error', onErrorEvent);

            try {
                // Attempt to load the manifest file
                await player.load(manifestUri);
                console.log('The video has now been loaded!');
            } catch (e) {
                // onError is called if the license server or manifest fails
                onError(e);
            }
        }

        function onErrorEvent(event) {
            // Extract the shaka.util.Error object from the event
            onError(event.detail);
        }

        function onError(error) {
            // Log the error to the console
            console.error('Shaka Player Error:', error.code, 'Object', error);
        }

        // Using shaka.Player.isBrowserSupported() is the correct method
        // for checking browser compatibility.
        if (shaka.Player.isBrowserSupported()) {
            // Wait for the DOM to be loaded before initializing the player
            document.addEventListener('DOMContentLoaded', init);
        } else {
            console.error('Browser not supported!');
        }
    </script>

</body>
</html>

